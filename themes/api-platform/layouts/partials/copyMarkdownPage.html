<div class="actions-container m-2 relative">
    <div id="page-context-menu" class="items-center shrink-0 min-w-[156px] justify-end ml-auto sm:flex hidden">
        <button id="page-context-menu-button" class="rounded-l-xl px-3 text-gray-700 dark:text-gray-300 py-1.5 border border-gray-200 dark:border-white/[0.07] bg-background-light dark:bg-background-dark hover:bg-gray-600/5 dark:hover:bg-gray-200/5 border-r-0">
            <span class="flex items-center gap-2 text-sm text-center font-medium">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4">
                    <path d="M14.25 5.25H7.25C6.14543 5.25 5.25 6.14543 5.25 7.25V14.25C5.25 15.3546 6.14543 16.25 7.25 16.25H14.25C15.3546 16.25 16.25 15.3546 16.25 14.25V7.25C16.25 6.14543 15.3546 5.25 14.25 5.25Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M2.80103 11.998L1.77203 5.07397C1.61003 3.98097 2.36403 2.96397 3.45603 2.80197L10.38 1.77297C11.313 1.63397 12.19 2.16297 12.528 3.00097" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <span>Copy page</span>
            </span>
        </button>
        <button id="menu-toggle-button" class="group bg-background-light dark:bg-background-dark disabled:pointer-events-none [&amp;&gt;span]:line-clamp-1 overflow-hidden group flex items-center py-0.5 gap-1 text-sm text-gray-950/50 dark:text-white/50 group-hover:text-gray-950/70 dark:group-hover:text-white/70 rounded-none rounded-r-xl border px-3 border-gray-200 aspect-square dark:border-white/[0.07] bg-background-light dark:bg-background-dark hover:bg-gray-600/5 dark:hover:bg-gray-200/5" type="button" aria-haspopup="menu" aria-expanded="false" data-state="closed">
            <svg width="8" height="24" viewBox="0 -9 3 24" class="transition-transform text-gray-400 overflow-visible group-hover:text-gray-600 dark:text-gray-600 dark:group-hover:text-gray-400 rotate-90">
                <path d="M0 0L3 3L0 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
            </svg>
        </button>
    </div>

    <div id="dropdown-menu" class="hidden">
        <div class="inline-flex max-h-[420px] p-1 flex-col w-full">

            <div id="menu-copy-button" role="menuitem" class="text-sm group dark:focus:bg-background-light/5 relative w-full select-none outline-0 focus:bg-accent data-[disabled]:pointer-events-none data-[disabled]:cursor-default data-[disabled]:opacity-50 text-gray-950/50 dark:text-white/50 hover:text-gray-950/75 dark:hover:text-white/75 focus:text-gray-950/75 dark:focus:text-white/75 flex items-center justify-normal px-1.5 py-1.5 gap-1 hover:bg-gray-600/5 dark:hover:bg-gray-200/5 cursor-pointer rounded-xl">
                <div class="border border-gray-200 dark:border-white/[0.07] rounded-lg p-1.5">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0"><path d="M14.25 5.25H7.25C6.14543 5.25 5.25 6.14543 5.25 7.25V14.25C5.25 15.3546 6.14543 16.25 7.25 16.25H14.25C15.3546 16.25 16.25 15.3546 16.25 14.25V7.25C16.25 6.14543 15.3546 5.25 14.25 5.25Z" stroke="currentColor" stroke-width="1.s5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2.80103 11.998L1.77203 5.07397C1.61003 3.98097 2.36403 2.96397 3.45603 2.80197L10.38 1.77297C11.313 1.63397 12.19 2.16297 12.528 3.00097" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </div>
                <div class="flex flex-col px-1">
                    <div class="text-sm font-medium text-gray-800 dark:text-gray-300 flex items-center gap-1">Copy page</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Copy page as Markdown for LLMs</div>
                </div>
            </div>

            <div id="downloadButton" role="menuitem" class="text-sm group dark:focus:bg-background-light/5 relative w-full select-none outline-0 focus:bg-accent data-[disabled]:pointer-events-none data-[disabled]:cursor-default data-[disabled]:opacity-50 text-gray-950/50 dark:text-white/50 hover:text-gray-950/75 dark:hover:text-white/75 focus:text-gray-950/75 dark:focus:text-white/75 flex items-center justify-normal px-1.5 py-1.5 gap-1 hover:bg-gray-600/5 dark:hover:bg-gray-200/5 cursor-pointer rounded-xl">
                <div class="border border-gray-200 dark:border-white/[0.07] rounded-lg p-1.5">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0"><path d="M15.25 3.75H2.75C1.64543 3.75 0.75 4.64543 0.75 5.75V12.25C0.75 13.3546 1.64543 14.25 2.75 14.25H15.25C16.3546 14.25 17.25 13.3546 17.25 12.25V5.75C17.25 4.64543 16.3546 3.75 15.25 3.75Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8.75 11.25V6.75H8.356L6.25 9.5L4.144 6.75H3.75V11.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.5 9.5L13.25 11.25L15 9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M13.25 11.25V6.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </div>
                <div class="flex flex-col px-1">
                    <div class="text-sm font-medium text-gray-800 dark:text-gray-300 flex items-center gap-1">Download MarkDown</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">Download the raw .md file</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let fetchedText = '';
        let isFetching = false;

        const markdownLink = document.getElementById('markdownLink');
        const mainCopyButton = document.getElementById('page-context-menu-button');
        const menuToggleButton = document.getElementById('menu-toggle-button');
        const dropdownMenu = document.getElementById('dropdown-menu');

        if (!mainCopyButton || !menuToggleButton || !dropdownMenu || !markdownLink) {
            console.warn('Menu items or markdown links not found. Page actions are disabled.');
            return;
        }

        const mainCopyButtonSpan = mainCopyButton.querySelector('span');
        const originalMainCopyText = mainCopyButtonSpan.textContent;

        menuToggleButton.addEventListener('click', (event) => {
            event.stopPropagation();
            dropdownMenu.classList.toggle('hidden');
            const isExpanded = !dropdownMenu.classList.contains('hidden');
            menuToggleButton.setAttribute('aria-expanded', isExpanded);
            menuToggleButton.setAttribute('data-state', isExpanded ? 'open' : 'closed');
        });

        document.addEventListener('click', (event) => {
            if (!menuToggleButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
                menuToggleButton.setAttribute('aria-expanded', 'false');
                menuToggleButton.setAttribute('data-state', 'closed');
            }
        });

        async function fetchData(buttonElement) {
            if (isFetching) return false;
            isFetching = true;

            const url = markdownLink.href;
            if (!url) {
                console.error('Link (id="markdownLink") not found or without href.');
                isFetching = false;
                return false;
            }

            const textElement = buttonElement.querySelector('span') || buttonElement.querySelector('.font-medium');
            const originalText = textElement.textContent;

            textElement.textContent = 'Fetching...';
            buttonElement.classList.add('fetching');
            buttonElement.setAttribute('data-disabled', 'true');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                fetchedText = await response.text();

                return true;
            } catch (error) {
                console.error('Fetch error:', error);

                return false;
            } finally {
                isFetching = false;
                textElement.textContent = originalText;
                buttonElement.classList.remove('fetching');
                buttonElement.removeAttribute('data-disabled');
            }
        }

        async function copyData(buttonElement, textElement, originalText) {
            try {
                await navigator.clipboard.writeText(fetchedText);
                textElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');

                setTimeout(() => {
                    textElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error('Clipboard error:', error);
            }
        }

        function downloadFile(filename, text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        mainCopyButton.addEventListener('click', async () => {
            if (isFetching) return;
            if (!fetchedText) {
                const success = await fetchData(mainCopyButton);
                if (!success) return;
            }
            await copyData(mainCopyButton, mainCopyButtonSpan, originalMainCopyText);
        });

        dropdownMenu.addEventListener('click', async (event) => {
            if (isFetching) return;

            const copyButton = event.target.closest('#menu-copy-button');
            const downloadButton = event.target.closest('#downloadButton');

            if (copyButton) {
                const textElement = copyButton.querySelector('.font-medium');
                if (!fetchedText) {
                    const success = await fetchData(copyButton);
                    if (!success) return;
                }
                await copyData(copyButton, textElement, "Copy page");
            }

            if (downloadButton) {
                if (!fetchedText) {
                    const success = await fetchData(downloadButton);
                    if (!success) return;
                }
                downloadFile("document.md", fetchedText);
            }
        });
    });
</script>